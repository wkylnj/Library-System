# Django 图书馆管理系统 - 网站部署指南

## 一、环境准备

### 1.1 系统要求

- 操作系统：Ubuntu 20.04/22.04/24.04 LTS
- Python：3.10 或更高版本
- 内存：建议 1GB 以上
- 磁盘：建议 10GB 以上

### 1.2 检查 Python 版本

```bash
python3 --version
```

---

## 二、项目准备

### 2.1 进入项目目录

```bash
cd /root/website_homework/library_system
```

### 2.2 创建 Python 虚拟环境

```bash
python3 -m venv venv
```

### 2.3 激活虚拟环境

```bash
source venv/bin/activate
```

激活后，命令行提示符前会显示 `(venv)`。

### 2.4 安装项目依赖

```bash
pip install -r requirements.txt
```

依赖包内容（requirements.txt）：
- Django>=4.2 - Web 框架
- requests>=2.28.0 - HTTP 请求库
- gunicorn>=21.0.0 - WSGI 服务器

### 2.5 验证 Django 项目

```bash
python manage.py check
```

如果输出 `System check identified no issues`，说明项目配置正确。

---

## 三、Django 生产环境配置

### 3.1 配置静态文件收集目录

编辑 `config/settings.py`，添加 `STATIC_ROOT` 配置：

```python
# Static files (CSS, JavaScript, Images)
STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
STATIC_ROOT = BASE_DIR / 'staticfiles'  # 添加这一行
```

### 3.2 收集静态文件

```bash
python manage.py collectstatic --noinput
```

此命令会将所有静态文件收集到 `staticfiles` 目录，供 Nginx 直接服务。

---

## 四、安装和配置 Nginx

### 4.1 安装 Nginx

```bash
apt-get update
apt-get install -y nginx
```

### 4.2 创建 Nginx 配置文件

创建文件 `/etc/nginx/sites-available/library_system`：

```nginx
server {
    listen 80;
    server_name _;

    # 静态文件由 Nginx 直接处理
    location /static/ {
        alias /root/website_homework/library_system/staticfiles/;
    }

    # 动态请求转发给 Gunicorn
    location / {
        proxy_pass http://unix:/root/website_homework/library_system/gunicorn.sock;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4.3 启用站点配置

```bash
# 创建软链接启用配置
ln -sf /etc/nginx/sites-available/library_system /etc/nginx/sites-enabled/

# 删除默认配置
rm -f /etc/nginx/sites-enabled/default
```

### 4.4 测试 Nginx 配置

```bash
nginx -t
```

输出应显示 `syntax is ok` 和 `test is successful`。

---

## 五、配置 Gunicorn 服务

### 5.1 创建 Systemd 服务文件

创建文件 `/etc/systemd/system/gunicorn.service`：

```ini
[Unit]
Description=Gunicorn daemon for Library System
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=/root/website_homework/library_system
ExecStart=/root/website_homework/library_system/venv/bin/gunicorn --workers 3 --bind unix:/root/website_homework/library_system/gunicorn.sock config.wsgi:application
Restart=always

[Install]
WantedBy=multi-user.target
```

### 5.2 重新加载 Systemd 配置

```bash
systemctl daemon-reload
```

---

## 六、启动服务

### 6.1 启动 Gunicorn

```bash
systemctl start gunicorn
systemctl enable gunicorn  # 设置开机自启
```

### 6.2 启动 Nginx

```bash
systemctl start nginx
systemctl enable nginx  # 设置开机自启
```

### 6.3 验证服务状态

```bash
systemctl status gunicorn
systemctl status nginx
```

两个服务都应显示 `active (running)`。

---

## 七、访问网站

### 7.1 获取服务器 IP

```bash
# 内网 IP
hostname -I | awk '{print $1}'

# 公网 IP（如果有）
curl -s ifconfig.me
```

### 7.2 浏览器访问

在浏览器中输入服务器 IP 地址即可访问网站：

```
http://服务器IP地址
```

---

## 八、防火墙配置（如需要）

### 8.1 Ubuntu UFW 防火墙

```bash
ufw allow 80/tcp
ufw allow 443/tcp  # 如果使用 HTTPS
ufw reload
```

### 8.2 云服务器安全组

如果使用阿里云、腾讯云等云服务器，需要在控制台的安全组中放行：
- 入站规则：TCP 80 端口
- 入站规则：TCP 443 端口（HTTPS）

---

## 附录 A：服务管理命令

### A.1 启动服务

```bash
# 启动 Gunicorn
systemctl start gunicorn

# 启动 Nginx
systemctl start nginx

# 一键启动两个服务
systemctl start gunicorn nginx
```

### A.2 停止服务

```bash
# 停止 Gunicorn
systemctl stop gunicorn

# 停止 Nginx
systemctl stop nginx

# 一键停止两个服务
systemctl stop gunicorn nginx
```

### A.3 重启服务

```bash
# 重启 Gunicorn（代码更新后使用）
systemctl restart gunicorn

# 重启 Nginx（配置更新后使用）
systemctl restart nginx

# 一键重启两个服务
systemctl restart gunicorn nginx
```

### A.4 查看服务状态

```bash
# 查看 Gunicorn 状态
systemctl status gunicorn

# 查看 Nginx 状态
systemctl status nginx
```

### A.5 查看日志

```bash
# 查看 Gunicorn 日志
journalctl -u gunicorn -f

# 查看 Nginx 访问日志
tail -f /var/log/nginx/access.log

# 查看 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

### A.6 设置/取消开机自启

```bash
# 设置开机自启
systemctl enable gunicorn
systemctl enable nginx

# 取消开机自启
systemctl disable gunicorn
systemctl disable nginx
```

---

## 附录 B：常见问题排查

### B.1 502 Bad Gateway

**原因**：Gunicorn 未启动或 socket 文件不存在

**解决**：
```bash
systemctl restart gunicorn
ls -la /root/website_homework/library_system/gunicorn.sock
```

### B.2 静态文件 404

**原因**：静态文件未收集或路径配置错误

**解决**：
```bash
source venv/bin/activate
python manage.py collectstatic --noinput
```

### B.3 权限问题

**原因**：Nginx 无法访问 socket 文件

**解决**：
```bash
chmod 755 /root/website_homework/library_system
```

### B.4 端口被占用

**检查**：
```bash
netstat -tlnp | grep :80
```

**解决**：停止占用端口的进程或更换端口。

---

## 附录 C：项目文件结构

```
library_system/
├── config/                 # Django 项目配置
│   ├── settings.py        # 主配置文件
│   ├── urls.py            # URL 路由配置
│   └── wsgi.py            # WSGI 入口
├── books/                  # 图书应用
├── users/                  # 用户应用
├── templates/              # HTML 模板
├── static/                 # 开发环境静态文件
├── staticfiles/            # 生产环境静态文件（collectstatic 生成）
├── venv/                   # Python 虚拟环境
├── db.sqlite3             # SQLite 数据库
├── manage.py              # Django 管理脚本
├── requirements.txt       # Python 依赖
└── gunicorn.sock          # Gunicorn Unix Socket（运行时生成）
```
